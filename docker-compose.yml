services:
  # Transcription Pipeline - based on repository's docker-compose.pipeline.yml
  transcription-pipeline:
    build: ./pipeline
    container_name: ${PROJECT:+${PROJECT}-}${ENVIRONMENT:-production}-transcription-pipeline
    ports:
      - "${WEBHOOK_PORT:-9091}:${WEBHOOK_PORT:-9091}"  # Webhook handler port
    env_file: .env
    environment:
      - PROJECT=${PROJECT:-aiotp}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - DOMAIN_BASE=${DOMAIN_BASE:-localhost}
      - PARAKEET_CONTAINER=${PARAKEET_CONTAINER}
      - OLLAMA_CONTAINER=${OLLAMA_CONTAINER}
      - TELESALUD_CONTAINER=${TELESALUD_CONTAINER}
      - OPENEMR_CONTAINER=${OPENEMR_CONTAINER}
      - PROSODY_CONTAINER=${PROSODY_CONTAINER}
      - PARAKEET_WS_URL=${PARAKEET_WS_URL}
      - OLLAMA_API_URL=${OLLAMA_API_URL}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2:3b}
      - PROSODY_API_URL=${PROSODY_API_URL}
      - TELESALUD_API_BASE_URL=${TELESALUD_API_BASE_URL}
      - TELESALUD_API_TOKEN=${TELESALUD_API_TOKEN}
      - TELESALUD_API_URL=${TELESALUD_API_URL}
      - TELESALUD_WEBHOOK_URL=${TELESALUD_WEBHOOK_URL}
      - USE_WEBHOOK=${USE_WEBHOOK:-true}
      - OPENEMR_API_URL=${OPENEMR_API_URL}
      - OPENEMR_API_KEY=${OPENEMR_API_KEY:-}
      - WEBHOOK_PORT=${WEBHOOK_PORT:-9091}
      - WEBHOOK_HOST=${WEBHOOK_HOST:-0.0.0.0}
      - WEBHOOK_TOKEN=${WEBHOOK_TOKEN}
      - METADATA_DIR=${METADATA_DIR:-/shared/consultations}
      - SHARED_NOTES_DIR=${SHARED_NOTES_DIR:-/shared/notes}
      - RECORDINGS_DIR=/data
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./recordings:/recordings
      - ./logs:/logs
      - ./shared:/shared
      # Mount Jitsi recordings for speaker mapping (same as multitrack recorder)
      - ${JITSI_RECORDINGS_DIR:-/home/docto/telesalud/jitsi-docker/.jitsi-meet-cfg/recordings}:/data
    restart: unless-stopped
    networks:
      - frontend
      - shared
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${WEBHOOK_PORT:-9091}/webhook/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    command: ["python3", "/pipeline/webhook_handler.py"]

  # Real-Time Clinical Assistant
  realtime-assistant:
    build: ./realtime-assistant
    container_name: ${PROJECT:+${PROJECT}-}${ENVIRONMENT:-production}-realtime-assistant
    ports:
      - "${REALTIME_WS_PORT:-9092}:9092"    # WebSocket server for telesalud
      - "${REALTIME_HTTP_PORT:-9093}:9093"  # HTTP health check server
    env_file: .env
    environment:
      - PROJECT=${PROJECT:-aiotp}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - DOMAIN_BASE=${DOMAIN_BASE:-localhost}
      - PARAKEET_CONTAINER=${PARAKEET_CONTAINER}
      - TELESALUD_CONTAINER=${TELESALUD_CONTAINER}
      - REALTIME_PORT=9092
      - REALTIME_HTTP_PORT=9093
      - REALTIME_HOST=0.0.0.0
      - PARAKEET_WS_URL=${PARAKEET_WS_URL}
      - TELESALUD_API_BASE_URL=${TELESALUD_API_BASE_URL}
      - TELESALUD_API_TOKEN=${TELESALUD_API_TOKEN}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1
    volumes:
      - ./shared:/shared
    restart: unless-stopped
    networks:
      - frontend
      - shared
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9093/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  frontend:
    name: ${DOCKER_NETWORK:-frontend-official-production}
    external: true
  shared:
    name: ${SHARED_NETWORK:-official-shared-network}
    external: true